apiVersion: v1
kind: ConfigMap
metadata:
  name: oidc-setup
data:
  oidc-setup.sh: |
    set -e

    client_secret=$(cat /secrets/nextcloud-client-secret)

    # OIDC configuration:
    php occ config:app:set --type=string --value=0 user_oidc allow_multiple_user_backends
    php occ user_oidc:provider keycloak --clientid="nextcloud" --clientsecret="${client_secret}" --discoveryuri="{{ .Values.environment.hostname }}/realms/infrastructure/.well-known/openid-configuration"
